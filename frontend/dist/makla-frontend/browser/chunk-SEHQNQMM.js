import{a as I}from"./chunk-XBOEW2LX.js";import{a as y}from"./chunk-2LUDLJ2U.js";import{A as n,M as d,Q as g,U as f,Xb as m,a as p,b as u,k as S,n as i,s as l,y as T}from"./chunk-OOT27GPI.js";var U=(()=>{let c=class c{constructor(t,a){this.http=t,this.aiService=a,this.apiUrl=y.mealServiceUrl||`${y.apiUrl}/meals`,this.mealsSubject=new S([]),this.meals$=this.mealsSubject.asObservable()}getAllMeals(){return this.http.get(this.apiUrl).pipe(l(t=>t.map(a=>this.mapBackendToFrontend(a))),d(t=>this.mealsSubject.next(t)),n(t=>{console.warn("getAllMeals failed, falling back to local meals",t);let o=(JSON.parse(localStorage.getItem("local_meals")||"[]")||[]).map(e=>({id:e.id||null,name:e.name||e.mealType||"Repas local",description:e.description||"",mealTime:e.mealTime||e.mealType||"",foods:e.foods||[],totalCalories:e.calories||e.totalCalories||0,calories:e.calories||e.totalCalories||0,protein:e.protein||e.totalProtein||0,carbs:e.carbs||e.totalCarbs||0,fats:e.fats||e.totalFat||0,date:e.date||e.mealDate||new Date().toISOString()}));return this.mealsSubject.next(o),i(o)}))}getMealById(t){return this.http.get(`${this.apiUrl}/${t}`).pipe(l(a=>this.mapBackendToFrontend(a)))}createMeal(t){let a=this.mapFrontendToBackend(t);return this.http.post(this.apiUrl,a).pipe(l(o=>this.mapBackendToFrontend(o)),d(o=>{try{this.upsertMealInSubject(o)}catch{}this.refreshTodayMeals()}),n(o=>(console.warn("createMeal failed, saving locally",o),this.saveMealLocallyAndReturn(t).pipe(d(e=>{try{this.upsertMealInSubject(e)}catch{}})))))}syncLocalMeals(){try{let t=JSON.parse(localStorage.getItem("local_meals")||"[]");if(!t||!t.length)return i([]);let a=t.map(o=>{let e=this.mapFrontendToBackend(o);return this.http.post(this.apiUrl,e).pipe(l(s=>this.mapBackendToFrontend(s)),n(s=>(console.warn("syncLocalMeals: failed to push item",s),i(null))))});return T(a).pipe(l(o=>{let e=o.filter(s=>s&&typeof s=="object");if(e.length){try{localStorage.removeItem("local_meals")}catch{}this.refreshTodayMeals();try{this.aiService.updateDashboard("REFRESH_DATA")}catch{}}return e}),n(()=>i([])))}catch(t){return console.error("syncLocalMeals error",t),i([])}}updateMeal(t,a){let o=this.mapFrontendToBackend(a);return this.http.put(`${this.apiUrl}/${t}`,o).pipe(l(e=>this.mapBackendToFrontend(e)),d(()=>{this.refreshTodayMeals();try{this.aiService.updateDashboard("REFRESH_DATA")}catch{}}))}deleteMeal(t){return this.http.delete(`${this.apiUrl}/${t}`).pipe(d(()=>{this.refreshTodayMeals();try{this.aiService.updateDashboard("REFRESH_DATA")}catch{}}))}getTodayMeals(){let t=new Date().toISOString().split("T")[0];return this.http.get(`${this.apiUrl}/today`).pipe(l(a=>a.map(o=>u(p({},this.mapBackendToFrontend(o)),{calories:o.totalCalories??o.calories??0,protein:o.totalProtein??o.protein??0,carbs:o.totalCarbs??o.carbs??0,fats:o.totalFat??o.fats??0}))),d(a=>this.mealsSubject.next(a)),n(a=>{console.warn("getTodayMeals failed, falling back to local meals",a);let s=(JSON.parse(localStorage.getItem("local_meals")||"[]")||[]).filter(r=>(r.date||"").startsWith(t)).map(r=>({id:r.id??void 0,name:r.name||r.mealType||"Repas local",description:r.description||"",mealTime:r.mealTime??r.mealType??"",foods:r.foods||[],totalCalories:r.calories??r.totalCalories??0,calories:r.calories??r.totalCalories??0,protein:r.protein??r.totalProtein??0,carbs:r.carbs??r.totalCarbs??0,fats:r.fats??r.totalFat??0,date:r.date??new Date().toISOString()}));return this.mealsSubject.next(s),i(s)}))}refreshTodayMeals(){this.getTodayMeals().subscribe()}getMealsByDate(t){let a=t.toISOString().split("T")[0];return this.http.get(`${this.apiUrl}/by-date/${a}`).pipe(l(o=>o.map(e=>this.mapBackendToFrontend(e))),n(()=>i([])))}getMealHistory(t){return this.http.get(`${this.apiUrl}/history?days=${t}`).pipe(n(()=>i({meals:[],totalCalories:0})))}getUserMeals(){return this.getAllMeals()}mapFrontendToBackend(t){return{authUserId:1,name:t.name,description:t.description||"",mealDate:t.date||new Date().toISOString().split("T")[0],mealType:(t.mealTime||t.type||"LUNCH").toString().toUpperCase(),foodIds:t.foods?.map(a=>a.id).filter(a=>a!=null)||[],totalCalories:t.totalCalories||t.calories||0,totalProtein:t.protein||0,totalCarbs:t.carbs||t.carbohydrates||0,totalFat:t.fats||0,fiber:t.fiber||0}}mapBackendToFrontend(t){let a=t.name||t.mealType||"Repas",o=t.mealDate||t.date||t.createdAt||null,e=t.createdAt||(o?new Date(o).toISOString():void 0);return{id:t.id,name:a,description:t.description||"",mealTime:t.mealType||t.mealTime||"",type:(t.mealType||t.mealTime||"").toString().toLowerCase(),foods:t.foods||[],totalCalories:t.totalCalories||t.calories||0,calories:t.totalCalories||t.calories||0,protein:t.totalProtein||t.protein||0,carbs:t.totalCarbs||t.carbs||0,carbohydrates:t.totalCarbs||t.carbs||t.carbohydrates||0,fats:t.totalFat||t.fats||0,fiber:t.fiber??t.fibers??0,date:o,createdAt:e}}saveMealLocallyAndReturn(t){try{let a=JSON.parse(localStorage.getItem("local_meals")||"[]"),o=`local-${Date.now()}-${Math.floor(Math.random()*1e4)}`,e=u(p({},t),{uniqueId:o,id:t.id||void 0,date:t.date||new Date().toISOString()});a.push(e),localStorage.setItem("local_meals",JSON.stringify(a)),this.refreshTodayMeals();let s={id:e.id??void 0,name:e.name||"Local Meal",description:e.description||"",mealTime:e.mealTime||"LUNCH",foods:e.foods||[],totalCalories:e.calories||e.totalCalories||0,calories:e.calories||e.totalCalories||0,protein:e.protein||e.totalProtein||0,carbs:e.carbs||e.totalCarbs||0,fats:e.fats||e.totalFat||0,date:e.date};try{this.upsertMealInSubject(s)}catch{}return i(s)}catch(a){return console.error("Failed to save meal locally",a),i(t)}}upsertMealInSubject(t){try{let a=this.mealsSubject.value||[],o=a.findIndex(s=>s.id!==void 0&&s.id===t.id),e;if(o>=0)e=[...a],e[o]=p(p({},a[o]),t);else{let s=a.findIndex(r=>!r.id&&r.name===t.name&&r.date===t.date&&(r.calories||0)===(t.calories||0));s>=0?(e=[...a],e[s]=p(p({},a[s]),t)):e=[...a,t]}this.mealsSubject.next(e)}catch(a){console.warn("upsertMealInSubject failed",a)}}};c.\u0275fac=function(a){return new(a||c)(f(m),f(I))},c.\u0275prov=g({token:c,factory:c.\u0275fac,providedIn:"root"});let h=c;return h})();export{U as a};
